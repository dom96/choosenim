language: c
os: linux
dist: bionic
env: BRANCH=1.2.4

matrix:
  include:
    - arch: amd64
    - arch: arm64
    - arch: ppc64le
    - os: osx
    - os: windows

cache:
  directories:
    - "$HOME/.choosenim"
    - "$TRAVIS_BUILD_DIR/git"
    - "$HOME/Nim"
    - "$HOME/.ccache"

install:
  # Use cacche and persist ~/.ccache to reduce nim build time
  - |
    if [[ "$TRAVIS_OS_NAME" == "macosx" ]]
    then
      brew update
      brew install ccache
      export PATH="/usr/local/opt/ccache/libexec:$PATH"
    else
      # ccache already installed on linux
      export PATH="/usr/lib/ccache:$PATH"
    fi
    find $HOME/.ccache/

  - |
    # Non-amd64 workarounds, specific to Travis
    if [[ "$TRAVIS_CPU_ARCH" != "amd64" ]]
    then
      # By default, choosenim does not echo build output. This means that when
      # building nim from source, there can be long silences in stdout/stderr.
      # Travis will timeout if no output is received in 10m. Non-amd64 archs do
      # more nim-building than amd64, since fewer nim binaries are available, so
      # there are more silences, and Travis will timeout. travis_wait is an
      # option, but I couldn't get it to work consistently and it swallows
      # output, which is not ideal. Setting CHOOSENIM_DEBUG=1 causes choosenim
      # to echo all build output and thus prevents Travis from timing out.
      export CHOOSENIM_DEBUG=1

      # If ~/.ccache is empty, skip some tests to prevent builds from timing
      # out. An initial build with a cold cache will fill ~/.ccache, which is
      # persisted by Travis, and subsequent builds will run all tests.
      # Generally this should be fine, but it could result in a PR build passing
      # and then subsequent builds for that same branch failing, or a PR build
      # passing and then tests for master failing once the PR is merged, since
      # skips will have hidden an issue. If the builds are failing because of
      # a Travis timeout, re-triggering the builds should work because ~/.ccache
      # is persisted even after failed builds, and the next build will be
      # faster and is less likely to timeout. Tests are never skipped for tags
      # or master.
      ccache_size=`(du -s ~/.ccache || echo 0) | cut -f1`
      echo "ccache_size=${ccache_size}"
      if [[ "$ccache_size" == "0" && -z "$TRAVIS_TAG" && "$TRAVIS_BRANCH" != "master" ]]
      then
        export CHOOSENIM_SKIP_TESTS="can choose v1.0.0,can update devel with git"
      fi
    fi

  # Use common Travis script maintained as a gist
  # https://gist.github.com/genotrance/fb53504a4fba88bc5201d3783df5c522
  - curl https://gist.github.com/genotrance/fb53504a4fba88bc5201d3783df5c522/raw/travis.sh -LsSf -o travis.sh
  - source travis.sh

script:
  - set -ex
  - nimble install -y -d
  - nim c --out:bin/choosenim src/choosenim
  - nimble test
  - yes | ./bin/choosenim stable # Workaround for `tester` overwriting original Nimble install.
  - |
    export VERSION="$(./bin/choosenim --version | cut -f2,2 -d' ' | sed 's/v//')"
    export OSNAME="$TRAVIS_OS_NAME"
    export ARCH="$TRAVIS_CPU_ARCH"
    export EXT=""
    case $TRAVIS_OS_NAME in
      windows ) export EXT=".exe" ;;
      osx ) export OSNAME="macosx" ;; # match nim system.hostOS value
    esac
    case $TRAVIS_CPU_ARCH in
      ppc64le ) export ARCH="powerpc64el" ;; # match nim system.hostCPU value
    esac
  - mv "bin/choosenim${EXT}" "bin/choosenim-${VERSION}_${OSNAME}_${ARCH}_debug${EXT}"
  - nimble build -d:release
  - mv "bin/choosenim${EXT}" "bin/choosenim-${VERSION}_${OSNAME}_${ARCH}${EXT}"
  - ls -l bin

notifications:
  irc: "chat.freenode.net#nimbuild"

deploy:
  provider: releases
  api_key:
    secure: "h7HQnn/pVHyR119IViY811WeX4lMl+hLpmMMND09r3LVOaH9MpMSkwQXa4aYF+/YV3vHaQINOExqTOXpzc/nP5O5VJMzfaEdA+o6HtkVgY1qsWllquUt0xnrvcFCLHcNQc/fwoS6Cow4yINsRTyGgo7p4zLnk5+yGSQTJiLTiMWHQiiRyCdrywBHFzcXG63MqRD7JJveA0OE/JoRNBNESGP6JTK6V7W2eanmlAjbjH8+dUJsxDr5LjoeRUUF+A+4AfulAOCsbPtURW3CIBD1jqYrFXzBYRgxbHaHwY5XxfPjHnWPHONYIruXx9oYyjL8uyrHzYSNCEnoQtBY0gzYOBFfUCNB3bcNDrSkzTXnRlnMcWcC6XyrTxUI7Lc+bZB5OFGoqYJzZK54qd5wmIDqZ+Wa2n1vq/hNfZ+95fYhG7oXgW/zeLWFdr8i46dRoBDfcD2e+OhJLk73FoGVwySffR2p5hCGWLdXFyMKiph1RC8JPiwMr4l6n9LmO1fbOwAjwTEXzj645mC1ExmsiTckGlOQC8UuvnxWg9xNggO40PCTuO64hF4YucDi6SzYttNn5VNli2XoWz9SkgQiKAxf4u2VN+S2Vt0Mtue8Z6CTb2GjEO+QrmVrW3oQmiCFM0LkiAo+0zoo8JK7PuT5EoAabfc0aZt/Ds8cLhPpoHQFxMY="
  file_glob: true
  file: bin/*
  skip_cleanup: true
  on:
    repo: dom96/choosenim
    tags: true
